class BlackJack : public CardGame{
  enum Action{
    INVALID, HIT, STAND
  };
    
  int extractAction(string text){
    istringstream strStr(text);
    int i = -1;
    if(strStr >> i){
      if(BlackJack::HIT == i || BlackJack::STAND == i)
	return i;
      else
	return BlackJack::INVALID;
    }
    else
      return BlackJack::INVALID;
      
  };

  int requestAction(int id, string name){
    int act = BlackJack::INVALID;
    string response = "";
    do{
      writeToChannel(name + ": Press 1 to hit or Press 2 to stand");
      response = readFromChannel();
      act = extractAction(response);
    }
    while(BlackJack::INVALID == act);    
    return act;
  };

  void play(){
    // deal the first player
    setTurn(1);
    while(players.size() != turn()){
      playWithCurrPlayer();
      incTurn();
    };
    //the dealer plays at the end
    setTurn(0);
    playWithCurrPlayer();
  };

  
  void playWithCurrPlayer(){
    BJPlayer* objPlayer = (BJPlayer *)players.at(turn());
    int action = -1;
    do{
      broadcast(objPlayer->name() + " your Cards are: "+ objPlayer->prettyPrintCards() +", your score is: " + iToS(objPlayer->score()));
      action = requestAction(objPlayer->id(), objPlayer->name());
      if(BlackJack::HIT == action){
	broadcast(objPlayer->name() + " goes for another card");
	  dealCard();
	  if(objPlayer->isBust()){
	    broadcast(objPlayer->name() + " score is: " + iToS(objPlayer->score()));
	    broadcast(objPlayer->name() + " is Bust, loses anyways!");
	    break;
	  }
      }
      else if(BlackJack::STAND == action){
	broadcast(objPlayer->name() + " stands , score is " + iToS(objPlayer->score()));
	break;
	}
      else{
	  cout << "error in program: action is : " <<  action << endl;
	  throw "error in program";
      };
    }
    while(true);
  };
  
  void anounceResults(){
    broadcast("Anouncing results");
    vector<Player*>::iterator it;
    BJPlayer* objPlayer = (BJPlayer *)players.at(0);
    bool isDealerBust = objPlayer->isBust();
    int dealerScore =  objPlayer->score();
    string message = "";
    message = objPlayer->name() + " score is " + iToS(dealerScore);
    broadcast(message);
    for(it = (players.begin()+1); players.end() != it; it++){
      objPlayer = (BJPlayer *)(*it);
      if(isDealerBust){
	if(!objPlayer->isBust())
	  message = objPlayer->name() + " wins against " + players.at(0)->name() +"  with score " + iToS(objPlayer->score());
	else
	  message = objPlayer->name() + " doesn't win against " + players.at(0)->name() +" coz both are bust!. ";
      }
      else{
	if(objPlayer->isBust()){
	  message = objPlayer->name() + " loses against " + players.at(0)->name();
	}
	else{
	  string outcome = "";
	  if(objPlayer->score() > dealerScore)
	    outcome = "wins";
	  else if(objPlayer->score() < dealerScore)
	    outcome = "loses";
	  else
	    outcome = "squares";
	  message = objPlayer->name() + outcome + " against " + players.at(0)->name();
	};
      };
      broadcast(message);
    };
  };

  void dealCard(int times = 1){
    for(int i=0;times != i; i++){
      players.at(turn())->addCard(cards.top());
      cards.pop();
    };
  };

  void dealCards(){
    broadcast("Dealing the cards...");
    //rules for dealing the cards
    vector<Player*>::iterator it;
    for(it = players.begin(); players.end() != it; it++){
      dealCard(2);
      incTurn();
    };
  };

  void incTurn(){
    _turn++;
  };

  void setTurn(int turn){
    _turn = turn;
  };
  int turn() const{
    return _turn;
  };
  int _turn;
public:
  ServerChannel* _channel;

  string readFromChannel(){
    string temp = "";
    temp = _channel->read();
    return temp;
  };
  void writeToChannel(string message){
    _channel->write(message);
  };
  BlackJack(string name, int numOfDecks,ServerChannel* channel) : CardGame(name, numOfDecks), _channel(channel), _turn(0){
    players.push_back(new BlackJackDealer(0));
  };
  
  void broadcast(string message){
    vector<Player*>::iterator it;
    for(it = players.begin(); players.end() != it; it++){
      (*it)->notify(message);
    };
    //cout << "about to write to channel" << endl;
    writeToChannel(message);
  };
  
  void start(){
    broadcast("Starting the game...");
    dealCards();
    play();
    anounceResults();
  };
};

